<template>
  <v-container class="pa-6">
    <v-card class="pa-6 rounded-lg">
      <v-card-title class="text-h5 font-weight-bold mb-6">
        새 프로젝트 생성
      </v-card-title>
      
      <v-card-text>
        <!-- 기본 정보 섹션 -->
        <div class="mb-6">
          <div class="text-subtitle-1 font-weight-medium mb-4">기본 정보</div>
          
          <div class="mb-4">
            <div class="text-body-2 font-weight-medium mb-2">기수</div>
            <v-text-field
              v-model="project.batch"
              type="number"
              outlined
              dense
              hide-details="auto"
              background-color="white"
            ></v-text-field>
          </div>

          <div class="mb-4">
            <div class="text-body-2 font-weight-medium mb-2">팀명</div>
            <v-text-field
              v-model="project.teamName"
              outlined
              dense
              hide-details="auto"
              background-color="white"
            ></v-text-field>
          </div>

          <div class="mb-4">
            <div class="text-body-2 font-weight-medium mb-2">서비스명</div>
            <v-text-field
              v-model="project.serviceName"
              outlined
              dense
              hide-details="auto"
              background-color="white"
            ></v-text-field>
          </div>

          <div class="mb-4">
            <div class="text-body-2 font-weight-medium mb-2">프로젝트 유형</div>
            <v-select
              v-model="project.projectType"
              :items="projectTypeOptions"
              outlined
              dense
              hide-details="auto"
              background-color="white"
            ></v-select>
          </div>
        </div>

        <!-- 상세 정보 섹션 -->
        <div class="mb-6">
          <div class="text-subtitle-1 font-weight-medium mb-4">상세 정보</div>
          
          <div class="mb-4">
            <div class="text-body-2 font-weight-medium mb-2">링크</div>
            <v-text-field
              v-model="project.link"
              outlined
              dense
              hide-details="auto"
              background-color="white"
            ></v-text-field>
          </div>

          <div class="mb-4">
            <div class="text-body-2 font-weight-medium mb-2">프로젝트 주제</div>
            <v-text-field
              v-model="project.domain"
              outlined
              dense
              hide-details="auto"
              background-color="white"
            ></v-text-field>
          </div>
        </div>

        <!-- 주요 기능 섹션 -->
        <div>
          <div class="text-subtitle-1 font-weight-medium mb-4">주요 기능</div>
          <div class="mb-4">
            <div class="text-body-2 font-weight-medium mb-2">주요 기능 입력</div>
            <v-text-field
              v-model="featureInput"
              hint="콤마(,)로 구분하여 여러 기능을 한 번에 입력할 수 있습니다"
              persistent-hint
              outlined
              dense
              hide-details="auto"
              background-color="white"
            ></v-text-field>
          </div>

          <v-chip-group class="mt-3">
            <v-chip
              v-for="(feature, index) in project.primaryFeatureList"
              :key="index"
              closable
              @click:close="removeFeature(index)"
              color="primary"
              text-color="white"
              class="mr-2 mb-2"
              small
            >
              {{ feature.utilityName }}
            </v-chip>
          </v-chip-group>
        </div>
      </v-card-text>

      <v-card-actions class="pt-6">
        <v-spacer></v-spacer>
        <v-btn
          color="primary"
          x-large
          min-width="150"
          @click="saveProject"
          elevation="2"
        >
          프로젝트 생성
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-container>
</template>

<script>
import { reactive, ref, watch } from "vue";
import axios from "axios";
import router from "@/router";

export default {
  setup() {
    const project = reactive({
      batch: "",
      teamName: "",
      serviceName: "",
      projectType: "",
      link: "",
      domain: "",
      primaryFeatureList: []
    });
    const projectTypeOptions = ref([]);
    const featureInput = ref("");

    const addFeature = () => {
      if (featureInput.value.trim() === "") return;
      let features = featureInput.value.split(",").map(f => ({ utilityName: f.trim() }));
      project.primaryFeatureList.push(...features);
      featureInput.value = "";
      console.log("✅ [addFeature] primaryFeatureList:", JSON.parse(JSON.stringify(project.primaryFeatureList)));
    };

    const removeFeature = (index) => {
      project.primaryFeatureList.splice(index, 1);
    };

    const fetchProjectTypes = async () => {
      try {
        const response = await axios.get(`${process.env.VUE_APP_API_BASE_URL}/project/types`);
        // 응답이 CommonDto 형태면 response.data.result, 아니면 response.data 사용
        projectTypeOptions.value = response.data.result || response.data;
      } catch (error) {
        console.error("❌ 프로젝트 유형 불러오기 실패:", error);
      }
    };

    const saveProject = async () => {
      if (!project.projectType) {
        alert("프로젝트 유형을 선택해주세요");
        return;
      }

      // featureInput에 값이 있다면, 저장 전에 primaryFeatureList에 추가
      if (featureInput.value.trim() !== "") {
        const features = featureInput.value.split(",").map(f => ({ utilityName: f.trim() }));
        project.primaryFeatureList.push(...features);
        featureInput.value = ""; // 입력 필드 초기화
      }

      const projectData = {
        batch: project.batch,
        projectType: project.projectType,
        teamName: project.teamName,
        serviceName: project.serviceName,
        link: project.link,
        domain: project.domain,
        primaryFeatureSaveReqList: project.primaryFeatureList
      };

      console.log("🚀 백엔드로 보낼 데이터:", projectData);

      try {
        const response = await axios.post(`${process.env.VUE_APP_API_BASE_URL}/project/create`, projectData);
        console.log("✅ 프로젝트 생성 성공:", response.data);
        router.push({ path: "/ttt/project/find" }).then(() => {
          window.location.reload();
        });
      } catch (error) {
        console.error("❌ 프로젝트 생성 실패:", error);
        if (error.response && error.response.data && error.response.data.message) {
          console.log(error.response.data.message);
        }
      }
    };

    watch(() => project.primaryFeatureList, (newVal) => {
      console.log("🔄 [watch] primaryFeatureList 변경됨:", JSON.parse(JSON.stringify(newVal)));
    });

    return {
      project,
      projectTypeOptions,
      featureInput,
      addFeature,
      removeFeature,
      saveProject,
      fetchProjectTypes
    };
  },
  async created() {
    await this.fetchProjectTypes();
  }
};
</script>
